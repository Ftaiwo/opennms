/*! backshift 2015-03-30 */
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var Backshift=Backshift||{};Backshift.namespace=function(a){var b,c=a.split("."),d=Backshift;for("Backshift"===c[0]&&(c=c.slice(1)),b=0;b<c.length;b+=1)"undefined"==typeof d[c[b]]&&(d[c[b]]={}),d=d[c[b]];return d},Backshift.keys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},Backshift.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},Backshift.rows=function(a){var b=a.length;if(0===b)return[];for(var c=a[0].length,d=new Array(c),e=0;c>e;e++){for(var f=new Array(b),g=0;b>g;g++)f[g]=a[g][e];d[e]=f}return d},Backshift.fail=function(a){throw console.log("Error: "+a),{name:"Error",message:a}},Backshift.clone=function(a){return JSON.parse(JSON.stringify(a))},function(a){function b(a){return l.call(a)===s}function c(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function d(a){if(e(a)!==r)throw new TypeError;var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function e(a){switch(a){case null:return m;case void 0:return n}var b=typeof a;switch(b){case"boolean":return o;case"number":return p;case"string":return q}return r}function f(a){return"undefined"==typeof a}function g(a){var b=a.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=b.length||b[0]?b:[]}function h(a,b){var c=a;return function(){var a=i([k(c,this)],arguments);return b.apply(this,a)}}function i(a,b){for(var c=a.length,d=b.length;d--;)a[c+d]=b[d];return a}function j(a,b){return a=t.call(a,0),i(a,b)}function k(a,b){if(arguments.length<2&&f(arguments[0]))return this;var c=a,d=t.call(arguments,2);return function(){var a=j(d,arguments);return c.apply(b,a)}}var l=Object.prototype.toString,m="Null",n="Undefined",o="Boolean",p="Number",q="String",r="Object",s="[object Function]",t=Array.prototype.slice,u=function(){},v=function(){function a(){}function e(){function d(){this.initialize.apply(this,arguments)}var e=null,f=[].slice.apply(arguments);if(b(f[0])&&(e=f.shift()),c(d,v.Methods),d.superclass=e,d.subclasses=[],e){a.prototype=e.prototype,d.prototype=new a;try{e.subclasses.push(d)}catch(g){}}for(var h=0,i=f.length;i>h;h++)d.addMethods(f[h]);return d.prototype.initialize||(d.prototype.initialize=u),d.prototype.constructor=d,d}function f(a){var c=this.superclass&&this.superclass.prototype,e=d(a);i&&(a.toString!=Object.prototype.toString&&e.push("toString"),a.valueOf!=Object.prototype.valueOf&&e.push("valueOf"));for(var f=0,j=e.length;j>f;f++){var l=e[f],m=a[l];if(c&&b(m)&&"$super"==g(m)[0]){var n=m;m=h(function(a){return function(){return c[a].apply(this,arguments)}}(l),n),m.valueOf=k(n.valueOf,n),m.toString=k(n.toString,n)}this.prototype[l]=m}return this}var i=function(){for(var a in{toString:1})if("toString"===a)return!1;return!0}();return{create:e,Methods:{addMethods:f}}}();a.exports?a.exports.Class=v:a.Class=v}(Backshift),Backshift.namespace("Backshift.Class.Configurable"),Backshift.Class.Configurable=Backshift.Class.create({configure:function(a){a=a||{},Backshift.keys(this.defaults()).forEach(function(b){return a.hasOwnProperty(b)?void("object"==typeof this.defaults()[b]?Backshift.keys(this.defaults()[b]).forEach(function(c){this[b][c]=void 0!==a[b][c]?a[b][c]:void 0!==this[b][c]?this[b][c]:this.defaults()[b][c]},this):this[b]=void 0!==a[b]?a[b]:void 0!==this[b]?this[b]:this.defaults()[b]):void(this[b]=this[b]||this.defaults()[b])},this)}}),Backshift.namespace("Backshift.Math"),Backshift.Math={},Backshift.Math.lcm=function(a){if(void 0===a||a.length<1)return 0;for(var b=a.length,c=Math.abs(a[0]),d=1;b>d;d++){for(var e=Math.abs(a[d]),f=c;c&&e;)c>e?c%=e:e%=c;c=Math.abs(f*a[d])/(c+e)}return c},Backshift.namespace("Backshift.Stats"),Backshift.Stats={},Backshift.Stats.Maximum=function(a){var b,c=0/0;for(b=a.length;b--;)isNaN(a[b])||(isNaN(c)?c=a[b]:a[b]>c&&(c=a[b]));return c},Backshift.Stats.Minimum=function(a){var b,c=0/0;for(b=a.length;b--;)isNaN(a[b])||(isNaN(c)?c=a[b]:a[b]<c&&(c=a[b]));return c},Backshift.Stats.Average=function(a){if(0===a.length)return 0/0;var b,c=0,d=0;for(b=a.length;b--;)isNaN(a[b])||(c+=a[b],d++);return 1>d?0/0:c/d},Backshift.Stats.StdDev=function(a){if(a.length<2)return 0/0;for(var b=0,c=0,d=a.length,e=0;d>e;++e)if(!isNaN(a[e])){var f=a[e],g=f-b;b+=g/(e+1),c+=g*(f-b)}return Math.sqrt(c/(d-1))},Backshift.Stats.Last=function(a){var b;for(b=a.length;b--;)if(!isNaN(a[b]))return a[b];return 0/0},Backshift.Stats.First=function(a){var b,c=a.length;for(b=0;c>b;b++)if(!isNaN(a[b]))return a[b];return 0/0},Backshift.Stats.Total=function(a){if(0===a.length)return 0/0;var b,c=0;for(b=a.length;b--;)isNaN(a[b])||(c+=a[b]);return c},Backshift.Stats.Map={max:Backshift.Stats.Maximum,min:Backshift.Stats.Minimum,avg:Backshift.Stats.Average,stdev:Backshift.Stats.StdDev,last:Backshift.Stats.Last,first:Backshift.Stats.First,total:Backshift.Stats.Total},Backshift.namespace("Backshift.Utilities.Url"),Backshift.Utilities.Url=Backshift.Class.create({initialize:function(a){this.url=a,this.paramCount=0},andParam:function(a,b){var c=this.paramCount>0?"&":"?";return void 0!==b&&(this.paramCount+=1,this.url=this.url+c+a+"="+b),this},toString:function(){return this.url}}),Backshift.namespace("Backshift.Utilities.RpnToJexlConverter"),Backshift.Utilities.RpnToJexlConverter=Backshift.Class.create({initialize:function(){this.operators={},this._buildOperators()},_buildOperators:function(){var a=function(a){return function(b){var c=b.pop(),d=b.pop();return"("+d+" "+a+" "+c+")"}},b=function(a){var b=a.pop(),c=a.pop(),d=a.pop();return"("+d+" != 0 ? "+c+" : "+b+")"},c=function(a){var b=a.pop();return"( ("+b+" == __inf) || ("+b+" == __neg_inf) ? 1 : 0)"},d=function(a){return function(b){var c=b.pop(),d=b.pop();return"("+d+" "+a+" "+c+" ? 1 : 0)"}};this.operators["+"]=a("+"),this.operators["-"]=a("-"),this.operators["*"]=a("*"),this.operators["/"]=a("/"),this.operators["%"]=a("%"),this.operators.IF=b,this.operators.UN=c,this.operators.LT=d("<"),this.operators.LE=d("<="),this.operators.GT=d(">"),this.operators.GE=d(">="),this.operators.EQ=d("=="),this.operators.NE=d("!=")},convert:function(a){var b,c,d,e,f=[];for(c=a.split(","),d=c.length,e=0;d>e;e++)b=c[e],f.push(this._isOperator(b)?this._toExpression(b,f):b);return 1===f.length?f.pop():void Backshift.fail("Too many input values in RPN express. RPN: "+a+" Stack: "+JSON.stringify(f))},_isOperator:function(a){return a in this.operators},_toExpression:function(a,b){return this.operators[a](b)}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphVisitor=Backshift.Class.create({initialize:function(a){this.onInit(a)},onInit:function(){},_visit:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=function(){var a=function(a,b){for(var c=[],d=!1,e="",f=a.length,g=0;f>g;g++)" "!==a.charAt(g)||d?'"'===a.charAt(g)&&b?(d=!d,e+=a.charAt(g)):e+=a.charAt(g):(c.push(e),e="");return c.push(e),c};return{parse:a}}(),o=n.parse(a.command,!0),p=o.length;for(b=0;p>b;b++){var q=o[b].split(":");c=q[0],"DEF"===c?(i=q[1].split("="),d=i[0],e=i[1],f=q[2],g=q[3],this._onDEF(d,e,f,g)):"CDEF"===c?(i=q[1].split("="),d=i[0],h=i[1],this._onCDEF(d,h)):c.match(/LINE/)?(j=parseInt(/LINE(\d+)/.exec(c)),i=q[1].split("#"),k=i[0],l="#"+i[1],m=q[2],this._onLine(k,l,m,j)):"AREA"===c?(i=q[1].split("#"),k=i[0],l="#"+i[1],m=q[2],this._onArea(k,l,m)):"STACK"===c&&(i=q[1].split("#"),k=i[0],l="#"+i[1],m=q[2],this._onStack(k,l,m))}},_onDEF:function(){},_onCDEF:function(){},_onLine:function(){},_onArea:function(){},_onStack:function(){}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphConverter=Backshift.Class.create(Backshift.Utilities.RrdGraphVisitor,{onInit:function(a){this.graphDef=a.graphDef,this.resourceId=a.resourceId,this.model={sources:[],series:[]},this.rpnConverter=new Backshift.Utilities.RpnToJexlConverter;var b,c,d=this.graphDef.propertiesValues.length;for(c=0;d>c;c++){b=this.graphDef.propertiesValues[c];var e=new RegExp("\\{"+b+"}","g");this.graphDef.command=this.graphDef.command.replace(e,b)}this._visit(this.graphDef);var f={};for(d=this.model.series.length,c=0;d>c;c++)f[this.model.series[c].source]=1;var g;for(d=this.model.sources.length,c=0;d>c;c++)g=this.model.sources[c],g.transient=!(g.name in f)},_onDEF:function(a,b,c,d){var e=parseInt(/\{rrd(\d+)}/.exec(b)[1])-1,f=this.graphDef.columns[e];this.model.sources.push({name:a,resourceId:this.resourceId,attribute:f,aggregation:d})},_onCDEF:function(a,b){this.model.sources.push({name:a,expression:this.rpnConverter.convert(b)})},_onLine:function(a,b,c){this.model.series.push({name:c,source:a,type:"line",color:b})},_onArea:function(a,b,c){this.model.series.push({name:c,source:a,type:"area",color:b})},_onStack:function(a,b,c){this.model.series.push({name:c,source:a,type:"stack",color:b})}}),Backshift.namespace("Backshift.Graph"),Backshift.Graph=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(a){void 0===a.model&&Backshift.fail("Graph needs a model."),this.validateModel(a.model),this.model=a.model,void 0===a.element&&Backshift.fail("Graph needs an element."),this.element=a.element,this.dp=this.createDataProcessor(),this.configure(a),0===this.start&&0===this.end&&0===this.last&&Backshift.fail("Graph needs start and end, or last to be non-zero."),this.fetchInProgress=!1,this.lastSuccessfulFetch=0,this.timer=null,this.onInit(a)},defaults:function(){return{width:400,height:240,resolution:0,start:0,end:0,last:0,refreshRate:3e4,checkInterval:1e3}},validateModel:function(a){void 0===a.dataProcessor&&Backshift.fail("Model must contain a data processor.")},createDataProcessor:function(){var a=this;return Backshift.Data.Factory.create(this.model.dataProcessor,{sources:this.model.sources,beforeFetch:function(b,c){a._beforeFetch(b,c)},onFetchSuccess:function(b,c){a._onFetchSuccess(b,c)},onFetchFail:function(b,c){a.onFetchFail(b,c)},afterFetch:function(b,c){a._afterFetch(b,c)},onNewData:function(b,c){a.onNewData(b,c)}})},render:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null),this.onRender(),this.refresh(),this.createTimer()},createTimer:function(){var a=this;this.timer=setInterval(function(){a.isRefreshRequired()&&a.refresh()},this.checkInterval)},setStart:function(a){this.start=a,this.refresh()},setEnd:function(a){this.end=a,this.refresh()},refresh:function(){var a=this.getTimeSpan();this.dp.fetch(a.start,a.end,this.getResolution())},isRefreshRequired:function(){return this.fetchInProgress?!1:0===this.refreshRate?!1:this.lastSuccessfulFetch<=Date.now()-this.refreshRate},getTimeSpan:function(){var a={};return this.last>0?(a.end=Math.floor(Date.now()/1e3),a.start=a.end-this.last):(a.end=this.end,a.start=this.start),a},getResolution:function(){return this.resolution>0?this.resolution:this.width},_beforeFetch:function(a,b){this.fetchInProgress=!0,this.beforeFetch(a,b)},_afterFetch:function(a,b){this.fetchInProgress=!1,this.afterFetch(a,b)},_onFetchSuccess:function(a,b){this.lastSuccessfulFetch=Date.now(),this.onFetchSuccess(a,b)},onInit:function(){},onRender:function(){},beforeFetch:function(){},onFetchSuccess:function(){},onFetchFail:function(){},afterFetch:function(){},onNewData:function(){}}),Backshift.namespace("Backshift.Data"),Backshift.Data=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(a){(void 0===a.sources||0===a.sources.length)&&Backshift.fail("Data provider needs one or more sources."),this.sources={};for(var b=0;b<a.sources.length;b++)this.sources[a.sources[b].name]={def:a.sources[b],values:[]};this.timestamps=[],this.configure(a),this.onInit(a)},defaults:function(){return{beforeFetch:function(){},onFetchSuccess:function(){},onFetchFail:function(){},afterFetch:function(){},onNewData:function(){}}},fetch:function(a,b,c,d){this.beforeFetch(this,d),this.onFetch(a,b,c,d)},getTimestamps:function(){return this.timestamps},getValues:function(a){if(!(a in this.sources))throw a+" was not added to the data processor.";return this.sources[a].values},getMatrix:function(){var a=["timestamp"],b=[this.getTimestamps()];return Backshift.keys(this.sources).forEach(function(c){var d=this.sources[c];a.push(c),b.push(d.values)},this),b.labels=a,b},onInit:function(){},onFetch:function(){},resizeTo:function(a){(void 0===this.timestamps||this.timestamps.length!=a)&&(this.timestamps=new Array(a)),Backshift.keys(this.sources).forEach(function(b){(void 0===this.sources[b].values||this.sources[b].values.length!=a)&&(this.sources[b].values=new Array(a))},this)}}),Backshift.namespace("Backshift.Data.Mock"),Backshift.Data.Mock=Backshift.Class.create(Backshift.Data,{defaults:function(a){return Backshift.extend(a(),{generator:function(){return 0}})},onFetch:function(a,b,c,d){this.resizeTo(c);for(var e=0;c>e;e++)this.timestamps[e]=a+e/(c-1)*(b-a);Backshift.keys(this.sources).forEach(function(a){var b=this.sources[a];for(e=0;c>e;e++)b.values[e]=this.generator(this.timestamps[e],b.def)},this),this.onFetchSuccess(this,d),this.afterFetch(this,d)}}),Backshift.namespace("Backshift.Data.Mock.Trig.FnFactory"),Backshift.Data.Mock.TrigFnFactory={},Backshift.Data.Mock.TrigFnFactory.create=function(a){var b=a.type.toLowerCase();if("function"!=typeof Backshift.Data.Mock.TrigFnFactory[b])throw{name:"Error",message:b+" doesn't exist"};return new Backshift.Data.Mock.TrigFnFactory[b](a)},Backshift.Data.Mock.TrigFnFactory.sin=function(a){this.amplitude=1,void 0!==a.amplitude&&(this.amplitude=a.amplitude),this.hshift=0,void 0!==a.hshift&&(this.hshift=a.hshift),this.vshift=0,void 0!==a.vshift&&(this.vshift=a.vshift),this.period=2*Math.PI,void 0!==a.period&&(this.period=a.period),this.fn=function(a){var b=2*Math.PI/this.period;return this.amplitude*Math.sin(b*(a-this.hshift))+this.vshift}},Backshift.namespace("Backshift.Data.Mock.Trig"),Backshift.Data.Mock.Trig=Backshift.Class.create(Backshift.Data.Mock,{defaults:function(a){return Backshift.extend(a(),{generator:this.trigonometricGenerator})},trigonometricGenerator:function(a,b){var c=Backshift.Data.Mock.TrigFnFactory.create(b);return c.fn(a)}}),Backshift.namespace("Backshift.Data.Newts"),Backshift.Data.Newts=Backshift.Class.create(Backshift.Data,{onInit:function(){this.resources={},Backshift.keys(this.sources).forEach(function(a){var b=this.sources[a].def,c=b.resource;c in this.resources?this.resources[c].push(b):this.resources[c]=[b]},this),this.step_sizes={},Backshift.keys(this.sources).forEach(function(a){var b=this.sources[a].def;void 0!==b.step&&(b.step in this.step_sizes?this.step_sizes[b.step]+=1:this.step_sizes[b.step]=1)},this),this.step_sizes.lcm=Backshift.Math.lcm(Backshift.keys(this.step_sizes))},defaults:function(a){return Backshift.extend(a(),{url:"http://127.0.0.1:8000/",username:"newts",password:"newts"})},onFetch:function(a,b,c,d){var e=this.getResolutionInSeconds(a,b,c);Backshift.keys(this.resources).forEach(function(c){var f=this.resources[c];if(!(f.length<1)){var g=JSON.stringify(this.getReport(f)),h=new Backshift.Utilities.Url(this.url+"measurements/"+c).andParam("start",a).andParam("end",b).andParam("resolution",e+"s").toString(),i=this,j=function(a){var b=a.length;i.resizeTo(b);for(var c=0;b>c;c++){var e=a[c].length;i.timestamps[c]=Math.floor(a[c][0].timestamp/1e3);for(var f=0;e>f;f++){var g=a[c][f];i.sources[g.name].values[c]=g.value}}i.onFetchSuccess(i,d),i.afterFetch(i,d)},k=function(){i.onFetchFail(i,d),i.afterFetch(i,d)};this.getMeasurements(h,g,j,k)}},this)},getReport:function(a){if(a.length<1)throw"Cannot build a report with no sources.";var b,c={interval:0/0,datasources:[],expressions:[],exports:[]},d=a.length;for(b=0;d>b;b++){var e=a[b];if(void 0!==e.step)if(isNaN(c.interval))c.interval=e.step;else if(c.interval!==e.step)throw"All of the steps must match for a given resource: "+c.interval+" vs "+e.step;void 0===e.expression?c.datasources.push({label:e.name,source:e.dsName,"function":e.csFunc,heartbeat:e.heartbeat}):c.expressions.push({label:e.name,expression:e.expression}),c.exports.push(e.name)}return c},getResolutionInSeconds:function(a,b,c){var d=(b-a)/c,e=Math.ceil(d/this.step_sizes.lcm);return 2>e&&(e=2),e*this.step_sizes.lcm},getMeasurements:function(a,b,c,d){jQuery.ajax({url:a,username:this.username,password:this.password,xhrFields:{withCredentials:!0},type:"POST",data:b,contentType:"application/json; charset=utf-8",dataType:"json",success:c,error:d})}}),Backshift.namespace("Backshift.Data.OnmsRRD"),Backshift.Data.OnmsRRD=Backshift.Class.create(Backshift.Data,{defaults:function(a){return Backshift.extend(a(),{url:"http://127.0.0.1:8980/opennms/rest/rrd",username:"admin",password:"admin"})},onFetch:function(a,b,c,d){var e=this.getQueryRequest(a,b,c),f=this,g=function(a){var b,c=a.timestamps.length;for(f.timestamps=a.timestamps,b=0;c>b;b++)f.timestamps[b]/=1e3;for(c=a.labels.length,b=0;c>b;b++)f.sources[a.labels[b]].values=a.columns[b].values;f.onFetchSuccess(f,d),f.afterFetch(f,d)},h=function(){f.onFetchFail(f,d),f.afterFetch(f,d)};this.getResults(e,g,h)},getQueryRequest:function(a,b,c){var d,e={start:1e3*a,end:1e3*b,step:Math.floor((b-a)/c),source:[],expression:[]},f=b-a;return Backshift.keys(this.sources).forEach(function(a){var b=this.sources[a];void 0!==b.def.resourceId?(d={aggregation:b.def.aggregation,attribute:b.def.attribute,label:b.def.name,resourceId:b.def.resourceId,"transient":b.def.transient},e.source.push(d)):(d={value:b.def.expression,label:b.def.name,"transient":b.def.transient},d.value=d.value.replace("{diffTime}",f),e.expression.push(d))},this),0===e.source.length&&delete e.source,0===e.expression.length&&delete e.expression,e},getResults:function(a,b,c){jQuery.ajax({url:this.url,username:this.username,password:this.password,xhrFields:{withCredentials:!0},type:"POST",data:JSON.stringify(a),contentType:"application/json",dataType:"json",success:b,error:c})}}),Backshift.namespace("Backshift.Data.Factory"),Backshift.Data.Factory={},Backshift.Data.Factory.create=function(a,b){var c=a.type.toLowerCase();return"function"!=typeof Backshift.Data.Factory[c]&&Backshift.fail("Data provider "+c+" doesn't exist"),Backshift.keys(a).forEach(function(c){b[c]=a[c]}),new Backshift.Data.Factory[c](b)},Backshift.Data.Factory.trig=function(a){return new Backshift.Data.Mock.Trig(a)},Backshift.Data.Factory.newts=function(a){return new Backshift.Data.Newts(a)},Backshift.Data.Factory.onmsrrd=function(a){return new Backshift.Data.OnmsRRD(a)},Backshift.namespace("Backshift.Legend"),Backshift.Legend=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(a){void 0===a.model&&Backshift.fail("Legend needs a model."),this.model=a.model,void 0===a.element&&Backshift.fail("Legend needs an element."),this.element=a.element,this.dp=a.dataProcessor,"string"==typeof a.model.legend?this.template=a.model.legend:"[object Array]"===Object.prototype.toString.call(a.model.legend)?this.template=a.model.legend.join(" "):void 0===a.model.legend?this.template="":Backshift.fail("Invalid legend '"+a.model.legend+"'"),this.configure(a)},defaults:function(){return{width:400}},getSeriesContext:function(a){var b=Backshift.clone(a),c=this.dp.getValues(a.source);return Backshift.keys(Backshift.Stats.Map).forEach(function(a){b[a]=Backshift.Stats.Map[a](c)},this),b},render:function(){var a,b=this.model.series,c=b.length,d={};for(a=0;c>a;a++)d[a]=this.getSeriesContext(b[a]);for(d.series=[],a=0;c>a;a++)d.series.push(d[a]);var e=Mark.up(this.template,d);e.length>0&&(this.element.innerHTML="<pre>"+e+"</pre>")}}),Backshift.namespace("Backshift.Legend.Rickshaw"),Backshift.Legend.Rickshaw=Backshift.Class.create(Backshift.Legend,{initialize:function(a,b){this.graph=b.graph,b.width=this.graph.width,this.graphSeries={},this.graph.series.forEach(function(a){this.graphSeries[a.name]=a},this),a(b)},getSeriesContext:function(a,b){var c=a(b);return c.swatch="<div style='display: inline-block; width: 10px; height: 10px; margin: 0 8px 0 0; background-color: "+this.graphSeries[b.name].color+"'></div>",c}}),Backshift.namespace("Backshift.Graph.Matrix"),Backshift.Graph.Matrix=Backshift.Class.create(Backshift.Graph,{onInit:function(){this.statusBlock=null},beforeFetch:function(){this.timeBeforeFetch=Date.now(),this.updateStatus("Fetching...")},onFetchSuccess:function(a){this.drawMatrix(a);var b=Date.now(),c=Number((b-this.timeBeforeFetch)/1e3).toFixed(2);this.updateStatus("Successfully retrieved data in "+c+" seconds.")},onFetchFail:function(){this.updateStatus("Fetch failed.")},onNewData:function(){this.updateStatus("Received new data!")},updateStatus:function(a){this.statusBlock?this.statusBlock.text(a):this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(a)},drawMatrix:function(a){var b,c,d=a.getMatrix(),e=d.labels.length,f=new Array(e),g=0;Backshift.rows(d).forEach(function(a){for(b={},c=0;e>c;c++)b[d.labels[c]]=a[c];f[g++]=b},this);var h="";this.statusBlock&&(h=this.statusBlock.text()),d3.select(this.element).selectAll("*").remove(),this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(h),this.tabulate(this.element,f,d.labels),d3.select(this.element).attr("data-matrix",JSON.stringify(d)),d3.select(this.element).attr("data-rendered-at",Date.now())},tabulate:function(a,b,c){var d=d3.select(a).append("table").attr("style","font-size: 10px"),e=d.append("thead"),f=d.append("tbody");e.append("tr").selectAll("th").data(c).enter().append("th").text(function(a){return a});var g=f.selectAll("tr").data(b).enter().append("tr");return g.selectAll("td").data(function(a){return c.map(function(b){return{column:b,value:a[b]}})}).enter().append("td").attr("style","font-family: Courier; padding:0 15px 0 15px;").attr("align","center").html(function(a){return Number(a.value).toFixed(4)}),d}}),Backshift.namespace("Backshift.Graph.Rickshaw"),Backshift.Graph.Rickshaw=Backshift.Class.create(Backshift.Graph,{onInit:function(){this.graph=null,this.seriesData={};for(var a=this.model.series.length,b=0;a>b;b++){var c=this.model.series[b];(void 0===c.name||""===c.name)&&(c.name="series"+b),this.seriesData[c.name]=[]}this.previewDiv=null,this.legendDiv=null},updateSeriesData:function(a){var b,c,d,e,f,g,h=a.getTimestamps();f=this.model.series.length;var i={};for(d=0;f>d;d++)for(b=this.model.series[d],c=a.getValues(b.source),g=c.length,e=0;g>e;e++)isNaN(c[e])&&(i[e]=1);for(d=0;f>d;d++){b=this.model.series[d],c=a.getValues(b.source);for(var j=this.seriesData[b.name];j.length>0;)j.pop();for(g=c.length,e=0;g>e;e++)e in i||j.push({x:h[e],y:c[e]})}null!==this.graph&&this.graph.update()},getSeriesColor:function(a,b){return void 0!==a.color?a.color:b},getSeriesType:function(a,b){for(var c=a.length,d=b;c>d;d++)if("stack"===a[d].type)return"stack";return a[b].type},onRender:function(){var a=30,b=Math.floor(a/2),c=d3.select(this.element),d=c.node();d.style.width=this.width+a+"px",this.yAxisDiv=c.append("div");var e=this.yAxisDiv.node();e.style.width=a+"px",e.style.height=this.height+"px",e.style.float="left",this.chartDiv=c.append("div");var f=this.chartDiv.node();f.style.width=this.width+"px",f.style.height=this.height+"px",f.style.float="left",this.previewDiv=c.append("div");var g=this.previewDiv.node();g.style.width=this.width+"px",g.style.marginLeft=a+"px",g.style.float="left",this.legendDiv=c.append("div");var h=this.legendDiv.node();h.style.width=this.width+a-b+"px",h.style.paddingTop="10px",h.style.marginLeft=b+"px",h.style.clear="both";for(var i=new Rickshaw.Color.Palette({scheme:"classic9"}),j=[],k=this.model.series.length,l=0;k>l;l++){var m=this.model.series[l];j.push({name:m.name,data:this.seriesData[m.name],color:this.getSeriesColor(m,i.color()),renderer:this.getSeriesType(this.model.series,l)})}this.graph=new Rickshaw.Graph({element:f,renderer:"multi",width:this.width,height:this.height,min:"auto",preserve:this.model.preview,series:j,interpolation:"step-after",padding:{top:.02,left:.02,right:.02,bottom:.02}}),this.graph.render();var n=new Rickshaw.Graph.Axis.Time({graph:this.graph,orientation:"bottom",timeFixture:new Rickshaw.Fixtures.Time.Local});n.render();var o=new Rickshaw.Graph.Axis.Y({graph:this.graph,orientation:"left",element:e,tickFormat:Rickshaw.Fixtures.Number.formatKMBT});o.render(),this.legend=new Backshift.Legend.Rickshaw({model:this.model,graph:this.graph,element:this.legendDiv.node(),dataProcessor:this.dp}),this.legend.render(),new Rickshaw.Graph.HoverDetail({graph:this.graph,xFormatter:function(a){return new Date(1e3*a).toString()}})},onFetchSuccess:function(a){if(this.updateSeriesData(a),this.model.preview){var b=new Rickshaw.Graph.RangeSlider.Preview({graph:this.graph,element:this.previewDiv.node()});b.render()}this.legend.render(this.dp)}});